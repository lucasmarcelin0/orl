{% import 'admin/layout.html' as layout with context %}
{% import 'admin/static.html' as admin_static with context %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        {% block title %}
            {% if admin_view.category %}{{ admin_view.category }} - {% endif %}
            {{ admin_view.name }} - {{ admin_view.admin.name }}
        {% endblock %}
    </title>

    {% block head_css %}
        <link href="{{ admin_static.url(filename='bootstrap/bootstrap4/swatch/{swatch}/bootstrap.min.css'.format(swatch=theme.swatch), v='4.2.1') }}" rel="stylesheet" {{ admin_csp_nonce_attribute }}>
        {% if theme.swatch == 'default' %}
            <link href="{{ admin_static.url(filename='bootstrap/bootstrap4/css/bootstrap.min.css', v='4.2.1') }}" rel="stylesheet" {{ admin_csp_nonce_attribute }}>
        {% endif %}
        <link href="{{ admin_static.url(filename='admin/css/bootstrap4/admin.css', v='1.1.1') }}" rel="stylesheet" {{ admin_csp_nonce_attribute }}>
        <link href="{{ admin_static.url(filename='bootstrap/bootstrap4/css/font-awesome.min.css', v='4.7.0') }}" rel="stylesheet" {{ admin_csp_nonce_attribute }}>
        {% if admin_view.extra_css %}
            {% for css_url in admin_view.extra_css %}
                <link href="{{ css_url }}" rel="stylesheet" {{ admin_csp_nonce_attribute }}>
            {% endfor %}
        {% endif %}

        <style>
            :root {
                --primary: #1a4f8c;
                --primary-dark: #12345d;
                --danger: #e63946;
                --success: #2a9d8f;
                --background: #f5f7fb;
                --text: #1f2d3d;
                --muted: #6b7c93;
                --radius: 12px;
                --shadow: 0 10px 25px rgba(18, 52, 93, 0.08);
            }

            * {
                box-sizing: border-box;
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            }

            body {
                margin: 0;
                background: var(--background);
                color: var(--text);
            }

            a {
                color: var(--primary);
                text-decoration: none;
            }

            a:hover {
                text-decoration: underline;
            }

            header {
                background: white;
                box-shadow: var(--shadow);
                position: sticky;
                top: 0;
                z-index: 10;
            }

            .cke_notification_warning {
                display: none !important;
            }

            .header-content {
                max-width: 1200px;
                margin: 0 auto;
                padding: 18px 24px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 16px;
            }

            .header-content h1 {
                margin: 0;
                font-size: 1.4rem;
                color: var(--primary);
            }

            .admin-nav {
                display: flex;
                gap: 16px;
                flex-wrap: wrap;
                align-items: center;
            }

            main {
                max-width: 1200px;
                margin: 32px auto;
                padding: 0 24px 48px;
            }

            .messages {
                display: flex;
                flex-direction: column;
                gap: 12px;
                margin-bottom: 24px;
            }

            .message {
                padding: 14px 18px;
                border-radius: var(--radius);
                border-left: 4px solid transparent;
            }

            .message.success {
                background: rgba(42, 157, 143, 0.12);
                border-color: var(--success);
                color: var(--success);
            }

            .message.error {
                background: rgba(230, 57, 70, 0.12);
                border-color: var(--danger);
                color: var(--danger);
            }

            footer {
                text-align: center;
                padding: 24px;
                color: var(--muted);
                font-size: 0.85rem;
            }

            .admin-menu {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                list-style: none;
                padding: 0;
                margin: 0;
            }

            .admin-menu > li > a {
                font-weight: 600;
                padding: 8px 12px;
                border-radius: 8px;
                transition: background 0.2s ease;
                display: inline-flex;
                align-items: center;
                gap: 6px;
                color: var(--primary);
            }

            .admin-menu > li > a:hover,
            .admin-menu > li > a.active,
            .admin-menu > li > a:focus {
                background: rgba(26, 79, 140, 0.1);
                text-decoration: none;
            }

            @media (max-width: 720px) {
                .header-content {
                    flex-direction: column;
                    align-items: flex-start;
                }
            }
        </style>
    {% endblock %}

    {% block head %}{% endblock %}
    {% block head_tail %}{% endblock %}
</head>
<body>
{% block page_body %}
    <header>
        <div class="header-content">
            <h1>{{ admin_view.admin.name }}</h1>
            <nav class="admin-nav">
                <ul class="admin-menu">
                    {{ layout.menu() }}
                </ul>
                <ul class="admin-menu">
                    {{ layout.menu_links() }}
                </ul>
                <a href="{{ url_for('index') }}" target="_blank">Ver site</a>
            </nav>
        </div>
    </header>

    <main>
        {% block messages %}
            <div class="messages">
                {{ layout.messages() }}
            </div>
        {% endblock %}

        {% set render_ctx = h.resolve_ctx() %}

        {% block body %}{% endblock %}
    </main>

    <footer>
        Painel administrativo destinado aos colaboradores autorizados da Prefeitura Municipal de Orl√¢ndia.
    </footer>
{% endblock %}

    {% block tail_js %}
        {{ ckeditor.load() }}
        <script {{ admin_csp_nonce_attribute }} src="{{ admin_static.url(filename='vendor/jquery.min.js', v='3.5.1') }}" type="text/javascript"></script>
        <script {{ admin_csp_nonce_attribute }} src="{{ admin_static.url(filename='bootstrap/bootstrap4/js/popper.min.js') }}" type="text/javascript"></script>
        <script {{ admin_csp_nonce_attribute }} src="{{ admin_static.url(filename='bootstrap/bootstrap4/js/bootstrap.min.js', v='4.2.1') }}" type="text/javascript"></script>
        <script {{ admin_csp_nonce_attribute }} src="{{ admin_static.url(filename='vendor/moment.min.js', v='2.9.4') }}" type="text/javascript"></script>
        <script {{ admin_csp_nonce_attribute }} src="{{ admin_static.url(filename='vendor/bootstrap4/util.js', v='4.3.1') }}" type="text/javascript"></script>
        <script {{ admin_csp_nonce_attribute }} src="{{ admin_static.url(filename='vendor/bootstrap4/dropdown.js', v='4.3.1') }}" type="text/javascript"></script>
        <script {{ admin_csp_nonce_attribute }} src="{{ admin_static.url(filename='vendor/select2/select2.min.js', v='4.2.1') }}" type="text/javascript"></script>
        <script {{ admin_csp_nonce_attribute }} src="{{ admin_static.url(filename='vendor/multi-level-dropdowns-bootstrap/bootstrap4-dropdown-ml-hack.js') }}" type="text/javascript"></script>
        <script {{ admin_csp_nonce_attribute }} src="{{ admin_static.url(filename='admin/js/helpers.js', v='1.0.0') }}" type="text/javascript"></script>
        {% if admin_view.extra_js %}
            {% for js_url in admin_view.extra_js %}
                <script {{ admin_csp_nonce_attribute }} src="{{ js_url }}" type="text/javascript"></script>
            {% endfor %}
        {% endif %}
        <script {{ admin_csp_nonce_attribute }}>
            (function () {
                function whenReady(callback) {
                    if (document.readyState !== 'loading') {
                        callback();
                        return;
                    }
                    document.addEventListener('DOMContentLoaded', callback);
                }

                function buildConfig(textarea) {
                    const height = Number(textarea.dataset.ckeditorHeight || 360);
                    const toolbarMode = textarea.dataset.ckeditorToolbar || 'default';
                    const baseConfig = {
                        language: 'pt-br',
                        height: height,
                        removePlugins: 'flash,iframe,smiley',
                        toolbar: [
                            { name: 'clipboard', items: ['Undo', 'Redo'] },
                            { name: 'styles', items: ['Format'] },
                            {
                                name: 'basicstyles',
                                items: ['Bold', 'Italic', 'Underline', 'Strike', 'RemoveFormat'],
                            },
                            {
                                name: 'paragraph',
                                items: [
                                    'NumberedList',
                                    'BulletedList',
                                    '-',
                                    'JustifyLeft',
                                    'JustifyCenter',
                                    'JustifyRight',
                                    'JustifyBlock',
                                ],
                            },
                            { name: 'links', items: ['Link', 'Unlink'] },
                            { name: 'insert', items: ['Table', 'HorizontalRule', 'SpecialChar'] },
                            { name: 'tools', items: ['Maximize', 'Source'] },
                        ],
                    };

                    if (toolbarMode === 'minimal') {
                        baseConfig.toolbar = [
                            {
                                name: 'basicstyles',
                                items: ['Bold', 'Italic', 'Underline', 'RemoveFormat'],
                            },
                            { name: 'paragraph', items: ['NumberedList', 'BulletedList'] },
                            { name: 'links', items: ['Link', 'Unlink'] },
                            { name: 'clipboard', items: ['Undo', 'Redo'] },
                        ];
                    }

                    return baseConfig;
                }

                function ensureId(textarea, index) {
                    if (textarea.id) {
                        return textarea.id;
                    }
                    const generated = 'ckeditor-' + index + '-' + Date.now();
                    textarea.id = generated;
                    return generated;
                }

                function activateEditors() {
                    if (!window.CKEDITOR) {
                        return;
                    }

                    const textareas = document.querySelectorAll('textarea.ckeditor');
                    textareas.forEach(function (textarea, index) {
                        if (textarea.dataset.ckeditorAttached === '1') {
                            return;
                        }

                        const id = ensureId(textarea, index);
                        const config = buildConfig(textarea);

                        if (window.CKEDITOR.instances[id]) {
                            window.CKEDITOR.instances[id].destroy(true);
                        }

                        window.CKEDITOR.replace(id, config);
                        textarea.dataset.ckeditorAttached = '1';
                    });
                }

                function waitForEditor() {
                    if (window.CKEDITOR) {
                        activateEditors();

                        const observer = new MutationObserver(function () {
                            activateEditors();
                        });

                        observer.observe(document.body, {
                            childList: true,
                            subtree: true,
                        });

                        window.refreshRichTextEditors = activateEditors;
                        return;
                    }

                    window.setTimeout(waitForEditor, 150);
                }

                whenReady(waitForEditor);
            })();
        </script>
    {% endblock %}

{% block tail %}{% endblock %}
</body>
</html>
