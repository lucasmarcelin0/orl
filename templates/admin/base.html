{% import 'admin/layout.html' as layout with context %}
{% import 'admin/static.html' as admin_static with context %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        {% block title %}
            {% if admin_view.category %}{{ admin_view.category }} - {% endif %}
            {{ admin_view.name }} - {{ admin_view.admin.name }}
        {% endblock %}
    </title>

    {% block head_css %}
        {% set theme_swatch = theme.swatch if theme is defined and theme is not none and theme.swatch is defined else 'default' %}
        <link href="{{ admin_static.url(filename='bootstrap/bootstrap4/swatch/{swatch}/bootstrap.min.css'.format(swatch=theme_swatch), v='4.2.1') }}" rel="stylesheet" {{ admin_csp_nonce_attribute }}>
        {% if theme_swatch == 'default' %}
            <link href="{{ admin_static.url(filename='bootstrap/bootstrap4/css/bootstrap.min.css', v='4.2.1') }}" rel="stylesheet" {{ admin_csp_nonce_attribute }}>
        {% endif %}
        <link href="{{ admin_static.url(filename='admin/css/bootstrap4/admin.css', v='1.1.1') }}" rel="stylesheet" {{ admin_csp_nonce_attribute }}>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        {% if admin_view.extra_css %}
            {% for css_url in admin_view.extra_css %}
                <link href="{{ css_url }}" rel="stylesheet" {{ admin_csp_nonce_attribute }}>
            {% endfor %}
        {% endif %}

        <style>
            :root {
                --primary: #1a4f8c;
                --primary-dark: #12345d;
                --danger: #e63946;
                --success: #2a9d8f;
                --background: #f5f7fb;
                --text: #1f2d3d;
                --muted: #6b7c93;
                --radius: 12px;
                --shadow: 0 10px 25px rgba(18, 52, 93, 0.08);
            }

            * {
                box-sizing: border-box;
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            }

            body {
                margin: 0;
                background: var(--background);
                color: var(--text);
            }

            a {
                color: var(--primary);
                text-decoration: none;
            }

            a:hover {
                text-decoration: underline;
            }

            header {
                background: white;
                box-shadow: var(--shadow);
                position: sticky;
                top: 0;
                z-index: 10;
            }

            .cke_notification_warning {
                display: none !important;
            }

            .cabecalho-admin__conteudo {
                max-width: 1200px;
                margin: 0 auto;
                padding: 18px 24px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 16px;
            }

            .cabecalho-admin__titulo {
                margin: 0;
                font-size: 1.4rem;
                color: var(--primary);
            }

            .cabecalho-admin__identificacao {
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            .cabecalho-admin__usuario {
                font-weight: 600;
                color: var(--muted);
                font-size: 0.95rem;
            }

            .cabecalho-admin__acoes {
                display: flex;
                align-items: center;
                flex-wrap: wrap;
                gap: 16px;
            }

            .navegacao-admin {
                display: flex;
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .navegacao-admin__grupos {
                display: flex;
                flex-wrap: wrap;
                gap: 24px;
                align-items: stretch;
            }

            .navegacao-admin__grupo {
                display: flex;
                flex-direction: column;
                gap: 8px;
                min-width: 220px;
            }

            .navegacao-admin__grupo:first-child {
                flex: 1 1 320px;
            }

            .navegacao-admin__grupo:last-child {
                border-left: 1px solid rgba(26, 79, 140, 0.16);
                padding-left: 24px;
            }

            .navegacao-admin__rotulo {
                font-size: 0.75rem;
                letter-spacing: 0.08em;
                text-transform: uppercase;
                color: var(--muted);
                font-weight: 700;
            }

            .lista-navegacao--principal {
                gap: 10px;
            }

            .lista-navegacao--secundaria {
                gap: 6px;
            }

            .cabecalho-admin__atalho-site {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                font-weight: 600;
                color: var(--primary);
                padding: 8px 14px;
                border-radius: 999px;
                border: 1px solid rgba(26, 79, 140, 0.28);
                background: rgba(26, 79, 140, 0.08);
                transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
            }

            .cabecalho-admin__atalho-site:hover,
            .cabecalho-admin__atalho-site:focus {
                background: rgba(26, 79, 140, 0.16);
                text-decoration: none;
                box-shadow: 0 4px 12px rgba(18, 52, 93, 0.16);
            }

            main {
                max-width: 1200px;
                margin: 32px auto;
                padding: 0 24px 48px;
            }

            .messages {
                display: flex;
                flex-direction: column;
                gap: 12px;
                margin-bottom: 24px;
            }

            .message {
                padding: 14px 18px;
                border-radius: var(--radius);
                border-left: 4px solid transparent;
            }

            .message.success {
                background: rgba(42, 157, 143, 0.12);
                border-color: var(--success);
                color: var(--success);
            }

            .message.error {
                background: rgba(230, 57, 70, 0.12);
                border-color: var(--danger);
                color: var(--danger);
            }

            footer {
                text-align: center;
                padding: 24px;
                color: var(--muted);
                font-size: 0.85rem;
            }

            .lista-navegacao {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                list-style: none;
                padding: 0;
                margin: 0;
            }

            .lista-navegacao > li > a {
                font-weight: 600;
                padding: 8px 12px;
                border-radius: 8px;
                transition: background 0.2s ease;
                display: inline-flex;
                align-items: center;
                gap: 6px;
                color: var(--primary);
            }

            .lista-navegacao > li > a:hover,
            .lista-navegacao > li > a.active,
            .lista-navegacao > li > a:focus {
                background: rgba(26, 79, 140, 0.1);
                text-decoration: none;
            }

            .lista-navegacao__item--destaque {
                margin-left: 4px;
            }

            .lista-navegacao__botao {
                background: var(--primary);
                color: white !important;
                padding: 8px 14px;
                border-radius: 999px;
                display: inline-flex;
                align-items: center;
                gap: 6px;
                font-weight: 600;
                box-shadow: 0 6px 16px rgba(26, 79, 140, 0.18);
                transition: background 0.2s ease, box-shadow 0.2s ease;
            }

            .lista-navegacao__botao:hover,
            .lista-navegacao__botao:focus {
                background: var(--primary-dark);
                text-decoration: none;
                color: white;
                box-shadow: 0 8px 20px rgba(18, 52, 93, 0.22);
            }

            @media (max-width: 720px) {
                .cabecalho-admin__conteudo {
                    flex-direction: column;
                    align-items: flex-start;
                }
                .cabecalho-admin__acoes {
                    flex-direction: column;
                    align-items: flex-start;
                    width: 100%;
                }
                .navegacao-admin {
                    width: 100%;
                    gap: 20px;
                }
                .navegacao-admin__grupos {
                    flex-direction: column;
                    gap: 20px;
                    width: 100%;
                }
                .navegacao-admin__grupo {
                    min-width: 0;
                }
                .navegacao-admin__grupo:last-child {
                    border-left: none;
                    padding-left: 0;
                    border-top: 1px solid rgba(26, 79, 140, 0.16);
                    padding-top: 16px;
                }
                .cabecalho-admin__atalho-site {
                    width: 100%;
                    justify-content: center;
                }
            }
        </style>
    {% endblock %}

    {% block head %}{% endblock %}
    {% block head_tail %}{% endblock %}
</head>
<body>
{% block page_body %}
    <header class="cabecalho-admin">
        <div class="cabecalho-admin__conteudo">
            <div class="cabecalho-admin__identificacao">
                <h1 class="cabecalho-admin__titulo">{{ admin_view.admin.name }}</h1>
                {% if current_user.is_authenticated %}
                    <span class="cabecalho-admin__usuario">Olá, {{ current_user.name }}</span>
                {% endif %}
            </div>
            <div class="cabecalho-admin__acoes">
                <nav class="navegacao-admin" aria-label="Navegação principal do painel">
                    <div class="navegacao-admin__grupos">
                        <div class="navegacao-admin__grupo">
                            <span class="navegacao-admin__rotulo" id="rotulo-menu-principal">Menu principal</span>
                            <ul class="lista-navegacao lista-navegacao--principal" aria-labelledby="rotulo-menu-principal">
                                {{ layout.menu() }}
                                {% if current_user.is_authenticated and current_user.is_admin %}
                                    <li class="lista-navegacao__item--destaque">
                                        <a class="lista-navegacao__botao" href="{{ url_for('user.create_view') }}">
                                            <i class="fa-solid fa-user-plus" aria-hidden="true"></i>
                                            Criar conta de colaborador
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </div>
                        <div class="navegacao-admin__grupo">
                            <span class="navegacao-admin__rotulo" id="rotulo-menu-conta">Minha conta</span>
                            <ul class="lista-navegacao lista-navegacao--secundaria" aria-labelledby="rotulo-menu-conta">
                                {{ layout.menu_links() }}
                            </ul>
                        </div>
                    </div>
                </nav>
                <a class="cabecalho-admin__atalho-site" href="{{ url_for('index') }}" target="_blank" rel="noopener">
                    <i class="fa-solid fa-globe" aria-hidden="true"></i>
                    Ver site
                </a>
            </div>
        </div>
    </header>

    <main>
        {% block messages %}
            <div class="messages">
                {{ layout.messages() }}
            </div>
        {% endblock %}

        {% set render_ctx = h.resolve_ctx() %}

        {% block body %}{% endblock %}
    </main>

    <footer>
        Painel administrativo destinado aos colaboradores autorizados da Prefeitura Municipal de Orlândia.
    </footer>
{% endblock %}

    {% block tail_js %}
        {{ ckeditor.load() }}
        <script {{ admin_csp_nonce_attribute }} src="{{ admin_static.url(filename='vendor/jquery.min.js', v='3.5.1') }}" type="text/javascript"></script>
        <script {{ admin_csp_nonce_attribute }} src="{{ admin_static.url(filename='bootstrap/bootstrap4/js/popper.min.js') }}" type="text/javascript"></script>
        <script {{ admin_csp_nonce_attribute }} src="{{ admin_static.url(filename='bootstrap/bootstrap4/js/bootstrap.min.js', v='4.2.1') }}" type="text/javascript"></script>
        <script {{ admin_csp_nonce_attribute }} src="{{ admin_static.url(filename='vendor/moment.min.js', v='2.9.4') }}" type="text/javascript"></script>
        <script {{ admin_csp_nonce_attribute }} src="{{ admin_static.url(filename='vendor/bootstrap4/util.js', v='4.3.1') }}" type="text/javascript"></script>
        <script {{ admin_csp_nonce_attribute }} src="{{ admin_static.url(filename='vendor/bootstrap4/dropdown.js', v='4.3.1') }}" type="text/javascript"></script>
        <script {{ admin_csp_nonce_attribute }} src="{{ admin_static.url(filename='vendor/select2/select2.min.js', v='4.2.1') }}" type="text/javascript"></script>
        <script {{ admin_csp_nonce_attribute }} src="{{ admin_static.url(filename='vendor/multi-level-dropdowns-bootstrap/bootstrap4-dropdown-ml-hack.js') }}" type="text/javascript"></script>
        <script {{ admin_csp_nonce_attribute }} src="{{ admin_static.url(filename='admin/js/helpers.js', v='1.0.0') }}" type="text/javascript"></script>
        {% if admin_view.extra_js %}
            {% for js_url in admin_view.extra_js %}
                <script {{ admin_csp_nonce_attribute }} src="{{ js_url }}" type="text/javascript"></script>
            {% endfor %}
        {% endif %}
        <script {{ admin_csp_nonce_attribute }}>
            (function () {
                function whenReady(callback) {
                    if (document.readyState !== 'loading') {
                        callback();
                        return;
                    }
                    document.addEventListener('DOMContentLoaded', callback);
                }

                const uploadEndpoint = '{{ url_for("upload_ckeditor_image") }}';
                window.__orlImageUploadEndpoint = uploadEndpoint;

                function buildConfig(textarea) {
                    const height = Number(textarea.dataset.ckeditorHeight || 360);
                    const toolbarMode = textarea.dataset.ckeditorToolbar || 'default';
                    const baseConfig = {
                        language: 'pt-br',
                        height: height,
                        removePlugins: 'flash,iframe,smiley',
                        extraPlugins: 'uploadimage',
                        extraAllowedContent: 'i[*](*){*};span[*](*){*}',
                        filebrowserUploadUrl: uploadEndpoint,
                        filebrowserUploadMethod: 'form',
                        imageUploadUrl: uploadEndpoint,
                        toolbar: [
                            { name: 'clipboard', items: ['Undo', 'Redo'] },
                            { name: 'styles', items: ['Format'] },
                            {
                                name: 'basicstyles',
                                items: ['Bold', 'Italic', 'Underline', 'Strike', 'RemoveFormat'],
                            },
                            {
                                name: 'paragraph',
                                items: [
                                    'NumberedList',
                                    'BulletedList',
                                    '-',
                                    'JustifyLeft',
                                    'JustifyCenter',
                                    'JustifyRight',
                                    'JustifyBlock',
                                ],
                            },
                            { name: 'links', items: ['Link', 'Unlink'] },
                            { name: 'insert', items: ['Image', 'UploadImage', 'Table', 'HorizontalRule', 'SpecialChar'] },
                            { name: 'tools', items: ['Maximize', 'Source'] },
                        ],
                    };

                    if (toolbarMode === 'minimal') {
                        baseConfig.toolbar = [
                            {
                                name: 'basicstyles',
                                items: ['Bold', 'Italic', 'Underline', 'RemoveFormat'],
                            },
                            { name: 'paragraph', items: ['NumberedList', 'BulletedList'] },
                            { name: 'links', items: ['Link', 'Unlink'] },
                            { name: 'clipboard', items: ['Undo', 'Redo'] },
                        ];
                    }

                    return baseConfig;
                }

                function ensureId(textarea, index) {
                    if (textarea.id) {
                        return textarea.id;
                    }
                    const generated = 'ckeditor-' + index + '-' + Date.now();
                    textarea.id = generated;
                    return generated;
                }

                function activateEditors() {
                    if (!window.CKEDITOR) {
                        return;
                    }

                    const textareas = document.querySelectorAll('textarea.ckeditor');
                    textareas.forEach(function (textarea, index) {
                        if (textarea.dataset.ckeditorAttached === '1') {
                            return;
                        }

                        const id = ensureId(textarea, index);
                        const config = buildConfig(textarea);

                        if (window.CKEDITOR.instances[id]) {
                            window.CKEDITOR.instances[id].destroy(true);
                        }

                        window.CKEDITOR.replace(id, config);
                        textarea.dataset.ckeditorAttached = '1';
                    });
                }

                function waitForEditor() {
                    if (window.CKEDITOR) {
                        activateEditors();

                        const observer = new MutationObserver(function () {
                            activateEditors();
                        });

                        observer.observe(document.body, {
                            childList: true,
                            subtree: true,
                        });

                        window.refreshRichTextEditors = activateEditors;
                        return;
                    }

                    window.setTimeout(waitForEditor, 150);
                }

                whenReady(waitForEditor);
            })();
        </script>
    {% endblock %}

{% block tail %}{% endblock %}
</body>
</html>
