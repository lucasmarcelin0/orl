{% extends "base.html" %}

{% block title %}Resultados da busca por "{{ query }}" - Prefeitura Municipal de Orlândia{% endblock %}

{% block content %}
<section class="search-results">
    <div class="container">
        <div class="search-results__header">
            <h2>Resultados da busca</h2>
            <p>
                Exibindo {{ total_results }} {{ 'resultado' if total_results == 1 else 'resultados' }}
                para "<strong>{{ query }}</strong>".
            </p>
        </div>

        <form class="search-box search-results__form" action="{{ url_for('search') }}" method="get" role="search">
            <label class="sr-only" for="search-results-input">Buscar no site</label>
            <input
                id="search-results-input"
                type="search"
                name="q"
                value="{{ query }}"
                placeholder="Buscar novamente"
                aria-label="Buscar no site"
                required
            >
            <button type="submit"><i class="fas fa-search"></i> Buscar</button>
        </form>

        {% if page_results %}
        <div class="search-results__group">
            <h3>Páginas institucionais</h3>
            <ul class="search-results__list">
                {% for page in page_results %}
                <li class="search-results__item">
                    <h4><a href="{{ url_for('show_page', slug=page.slug) }}">{{ page.title }}</a></h4>
                    <p>{{ page.content | striptags | truncate(220, False, '…') }}</p>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if section_item_results %}
        <div class="search-results__group">
            <h3>Serviços, notícias e destaques</h3>
            <ul class="search-results__list">
                {% for item in section_item_results %}
                {% set summary_text = (item.summary or '') | striptags %}
                {% if item.section and item.section.section_type == 'news' %}
                    {% set item_link = url_for('news_detail', item_id=item.id) %}
                {% elif item.link_url and item.link_url != '#' %}
                    {% set item_link = item.link_url %}
                {% else %}
                    {% set item_link = url_for('home_item_detail', item_id=item.id) %}
                {% endif %}
                <li class="search-results__item">
                    <h4><a href="{{ item_link }}">{{ item.title }}</a></h4>
                    <p class="search-results__meta">
                        {% if item.section %}
                            {{ item.section.name }}
                        {% endif %}
                        {% if item.display_date %}
                            • {{ item.display_date }}
                        {% endif %}
                    </p>
                    {% if summary_text %}
                    <p>{{ summary_text | truncate(220, False, '…') }}</p>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if document_results %}
        <div class="search-results__group">
            <h3>Documentos</h3>
            <ul class="search-results__list">
                {% for document in document_results %}
                {% set document_url = document.public_path and url_for('static', filename=document.public_path) %}
                <li class="search-results__item">
                    <h4>
                        {% if document_url %}
                        <a href="{{ document_url }}" target="_blank" rel="noopener">
                            {{ document.title }}
                        </a>
                        {% else %}
                            {{ document.title }}
                        {% endif %}
                    </h4>
                    <p class="search-results__meta">
                        {% if document.section_item and document.section_item.section %}
                            Disponível em {{ document.section_item.section.name }}
                        {% elif document.section_item %}
                            Relacionado a {{ document.section_item.title }}
                        {% endif %}
                    </p>
                    {% if document.description %}
                    <p>{{ document.description | striptags | truncate(220, False, '…') }}</p>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if not page_results and not section_item_results and not document_results %}
        <p class="search-results__empty">
            Não encontramos resultados para "{{ query }}". Tente utilizar termos diferentes ou mais gerais.
        </p>
        {% endif %}
    </div>
</section>
{% endblock %}
